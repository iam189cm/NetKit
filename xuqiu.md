# NetKit 网卡配置功能改进需求文档

## 概述
本文档记录了NetKit网卡配置功能的详细改进需求，包括虚拟网卡过滤、网卡显示格式优化、自动刷新机制等。

## 1. 虚拟网卡过滤功能

### 1.1 功能描述
- 默认情况下只显示物理网卡，过滤虚拟网卡
- 提供"显示所有网卡"选项，用户可选择显示所有网卡

### 1.2 实现要求
- "显示所有网卡"复选框默认为不勾选状态
- 不勾选时：只显示物理网卡（以太网、Wi-Fi等）
- 勾选时：显示所有网卡（包括VMware、VirtualBox、Hyper-V等虚拟网卡）
- 网卡名称完整显示，下拉框宽度已调整为55

### 1.3 虚拟网卡识别
需要过滤的虚拟网卡类型：
- VMware Network Adapter系列
- VirtualBox Host-Only Network系列
- Hyper-V、Microsoft Teredo、TAP等虚拟网卡
- 蓝牙、VPN、PPP等特殊网卡

## 2. 网卡显示格式优化

### 2.1 显示格式
```
[状态] 网卡名称 (制造商 型号) - IP地址
```

### 2.2 显示示例
```
[已连接] 以太网 (Realtek PCIe GBE) - 192.168.1.100
[已断开] Wi-Fi (Intel AX200 160MHz) - 未配置
[已连接] 以太网 2 (USB 3.0 Gigabit) - 192.168.2.50
[已连接] VMware Network Adapter VMnet1 - 192.168.56.1
```

### 2.3 信息优先级
1. 状态（已连接/已断开）
2. 网卡名称
3. 硬件信息（制造商 型号）
4. IP地址

### 2.4 特殊情况处理
- 如果无法获取制造商/型号信息，显示：`[状态] 网卡名称 (未知) - IP地址`
- 虚拟网卡不需要特殊标识
- 不需要简化显示选项

## 3. 自动刷新机制

### 3.1 触发场景
自动刷新网卡列表和网卡信息的情况：
1. 插拔USB网卡
2. 网线插拔
3. Wi-Fi连接/断开
4. 成功应用静态IP配置后
5. 切换到DHCP后

### 3.2 技术实现
- 使用Windows WMI事件监听网络适配器变化
- 监听所有网络适配器事件
- 最小2秒刷新间隔，避免过度刷新
- 后台刷新，不阻塞UI线程

### 3.3 用户体验
- 刷新时在"刷新网卡"按钮内部显示小的加载图标
- 同时刷新网卡列表和当前选中网卡的详细信息
- 保持数据一致性

### 3.4 错误处理
- 刷新失败时重试一次
- 仍失败则在状态栏显示错误信息
- 错误信息格式：`"网卡刷新失败: 网络服务异常"`

## 4. Bug修复

### 4.1 刷新网卡按钮选择重置问题
- **问题**：点击"刷新网卡"按钮时，选择框自动切换到第一张网卡
- **修复**：保持用户的当前选择，不随意切换网卡
- **特殊情况**：如果用户当前选择的网卡在刷新后消失，显示"请选择网卡"

### 4.2 网卡消失处理
- 当前选中的网卡消失后，右侧网卡信息区域显示"未选择网卡"
- 清空所有网卡详细信息显示

## 5. 实现细节

### 5.1 网卡信息获取
需要获取的网卡信息：
- 网卡名称
- 连接状态
- 制造商和型号
- 当前IP地址
- 物理地址(MAC)
- 子网掩码
- 默认网关
- DNS服务器1
- DNS服务器2
另外，以上信息，用户可以进行选择，并可以复制。

### 5.2 物理网卡识别
通过以下方式识别物理网卡：
- 使用WMIC获取硬件信息
- 检查Manufacturer（制造商）
- 检查PhysicalAdapter（是否为物理适配器）
- 检查AdapterType（适配器类型）
- 已知物理网卡制造商：Intel、Realtek、Broadcom、Qualcomm、Marvell、Atheros等

### 5.3 刷新频率控制
- 最小刷新间隔：2秒
- 使用时间戳控制刷新频率
- 避免短时间内重复刷新影响性能

## 6. 测试要求

### 6.1 功能测试
- 测试虚拟网卡过滤功能
- 测试网卡显示格式
- 测试自动刷新机制
- 测试错误处理

### 6.2 性能测试
- 测试刷新频率控制
- 测试后台刷新不阻塞UI
- 测试WMI事件监听性能影响

### 6.3 兼容性测试
- 测试不同Windows版本
- 测试不同网卡制造商
- 测试虚拟机环境

## 7. 开发优先级

### 7.1 高优先级 ✅ 已完成
1. ✅ 修复刷新网卡按钮选择重置bug
2. ✅ 实现改进的网卡显示格式
3. ✅ 实现基本的自动刷新机制

### 7.2 中优先级 ✅ 已完成
1. ✅ 实现WMI事件监听
2. ✅ 实现刷新指示器
3. ✅ 完善错误处理

### 7.3 低优先级
1. 性能优化
2. 边界情况处理
3. 测试用例完善

## 8. 实现状态

### 8.1 已完成功能 ✅
- **虚拟网卡过滤**：默认隐藏虚拟网卡，可选择显示所有网卡
- **网卡显示格式优化**：`[状态] 网卡名称 (制造商 型号) - IP地址`
- **Bug修复**：修复刷新按钮导致选择重置的问题
- **自动刷新机制**：
  - 支持IP配置应用后自动刷新
  - 支持DHCP切换后自动刷新
  - 2秒最小刷新间隔控制
  - 后台刷新不阻塞UI
- **WMI事件监听**：监听网络适配器变化事件
- **刷新指示器**：刷新时显示"刷新中..."状态
- **错误处理**：刷新失败重试机制
- **模块化重构**：完整的代码模块化重构
  - Services层拆分为3个模块：网卡管理、信息获取、IP配置
  - Views层拆分为4个组件：选择器、信息显示、配置表单、状态显示
  - 统一的导入接口和向后兼容性

### 8.2 未实现功能 ⚠️
- ~~**信息复制功能**：网卡信息的选择和复制功能（需求5.1节提到）~~ ✅ 已完成

### 8.3 新增功能 ✅
- **信息复制功能**：简洁的网卡信息复制支持
  - 文本选择：用户可以用鼠标选择任意文本内容
  - 右键菜单：右键点击显示"复制"和"全选"菜单
  - 无额外按钮：保持UI简洁，不添加复制按钮
  - 原始文本：复制的是原始文本内容，不做任何处理
  - 标准体验：符合用户对文本复制的常规操作习惯

### 8.4 技术实现细节
- **网卡硬件信息获取**：使用WMIC获取制造商、型号信息
- **网络状态监听**：优先使用WMI事件，回退到轮询模式
- **线程安全**：后台刷新线程与UI线程分离
- **资源管理**：窗口关闭时自动清理监听资源
- **频率控制**：防止过度刷新影响性能
- **模块化架构**：
  - `netkit/services/netconfig/`：服务层模块
  - `gui/views/netconfig/`：UI组件模块
  - 清晰的职责分离和接口设计

---

**文档版本**: 1.0  
**创建日期**: 2024年12月  
**最后更新**: 2024年12月  
**负责人**: 开发团队 