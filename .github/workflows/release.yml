name: Release Build

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  release:
    types: [published, created]  # ç›‘å¬releaseäº‹ä»¶
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write  # å…è®¸åˆ›å»ºreleaseå’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-and-release:
    name: Build and Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        python scripts/build.py
        
    - name: Verify build
      run: |
        if (Test-Path "dist/NetKit.exe") {
          $fileSize = (Get-Item "dist/NetKit.exe").Length
          $fileSizeMB = [math]::Round($fileSize / 1MB, 1)
          Write-Host "Build successful! File size: $fileSizeMB MB" -ForegroundColor Green
        } else {
          Write-Host "Build failed!" -ForegroundColor Red
          exit 1
        }
      shell: powershell
      
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # è·å–æ ‡ç­¾åç§°
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $tag = "${{ github.event.inputs.tag }}"
        } else {
          $tag = "${{ github.ref_name }}"
        }
        
        $buildTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $commitSha = "${{ github.sha }}"
        
        # è·å–æ–‡ä»¶å¤§å°
        $fileSize = (Get-Item "dist/NetKit.exe").Length
        $fileSizeMB = [math]::Round($fileSize / 1MB, 1)
        
        $releaseBody = "## ğŸ”§ NetKit $tag - ç½‘ç»œå·¥ç¨‹å¸ˆå·¥å…·ç®±`n`n### ğŸ“¥ ä¸‹è½½`n- **NetKit.exe** - Windows å•æ–‡ä»¶ç‰ˆæœ¬ ($fileSizeMB MB)`n- é€‚ç”¨äº Windows 10/11/Server`n`n### ğŸŒ å®˜æ–¹ç½‘ç«™`n- è®¿é—® https://netkit.189cm.com/ è·å–æœ€æ–°ç‰ˆæœ¬å’Œä½¿ç”¨æ•™ç¨‹`n`n### ğŸš€ å¿«é€Ÿå¼€å§‹`n1. ä¸‹è½½ NetKit.exe æ–‡ä»¶`n2. å³é”®é€‰æ‹© \`"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ\`"`n3. å¼€å§‹ä½¿ç”¨ç½‘ç»œç®¡ç†åŠŸèƒ½`n`n### ğŸ’» ç³»ç»Ÿè¦æ±‚`n- Windows 10/11 æˆ– Windows Server`n- ç®¡ç†å‘˜æƒé™ï¼ˆæ¨èï¼Œç”¨äºç½‘ç»œé…ç½®åŠŸèƒ½ï¼‰`n`n### âš¡ æ ¸å¿ƒåŠŸèƒ½`n- ğŸ”„ IPåœ°å€å¿«é€Ÿåˆ‡æ¢`n- ğŸ“¡ Pingç½‘ç»œæµ‹è¯•`n- ğŸ§® å­ç½‘åœ°å€è®¡ç®—`n- ğŸ›¤ï¸ è·¯ç”±è¿½è¸ªåˆ†æ`n- ğŸ“‹ é™æ€è·¯ç”±ç®¡ç†`n`n### ğŸ”§ é€‚ç”¨äººç¾¤`nä¸“ä¸ºç½‘ç»œå·¥ç¨‹å¸ˆã€ç³»ç»Ÿç®¡ç†å‘˜è®¾è®¡çš„å®ç”¨å·¥å…·`n`n---`n**ğŸ“… æ„å»ºæ—¶é—´**: $buildTime  `n**ğŸ” ç‰ˆæœ¬Hash**: $($commitSha.Substring(0,8))  `n**âœ… å·²é€šè¿‡**: Windows 2019/2022/Latest å…¨å¹³å°æµ‹è¯•"
        
        # åªæœ‰åœ¨æ¨é€æ ‡ç­¾æˆ–æ‰‹åŠ¨è§¦å‘æ—¶æ‰åˆ›å»ºRelease
        if ("${{ github.event_name }}" -eq "push" -or "${{ github.event_name }}" -eq "workflow_dispatch") {
          gh release create $tag dist/NetKit.exe --title "NetKit $tag" --notes $releaseBody
        } else {
          # å¯¹äºreleaseäº‹ä»¶ï¼Œåªä¸Šä¼ æ–‡ä»¶åˆ°å·²å­˜åœ¨çš„release
          gh release upload $tag dist/NetKit.exe --clobber
        }
        
        # ä¸Šä¼ ä½¿ç”¨è¯´æ˜æ–‡æ¡£
        if (Test-Path "docs/ä½¿ç”¨è¯´æ˜_å•æ–‡ä»¶ç‰ˆæœ¬.md") {
          gh release upload $tag "docs/ä½¿ç”¨è¯´æ˜_å•æ–‡ä»¶ç‰ˆæœ¬.md" --clobber
        }
      shell: powershell
