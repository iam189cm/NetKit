name: Release Build

on:
  push:
    tags:
      - 'v*'  # Trigger when version tags are pushed
  release:
    types: [published, created]  # Listen to release events
  workflow_dispatch:  # Support manual trigger
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write  # Allow creating releases and uploading files

jobs:
  build-and-release:
    name: Build and Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable
      run: |
        python scripts/build.py
        
    - name: Rename executable with version
      run: |
        # Get tag name
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $tag = "${{ github.event.inputs.tag }}"
        } else {
          $tag = "${{ github.ref_name }}"
        }
        
        # Rename the executable to include version
        if (Test-Path "dist/NetKit.exe") {
          Rename-Item "dist/NetKit.exe" "NetKit-$tag.exe"
          Write-Host "Renamed to NetKit-$tag.exe" -ForegroundColor Green
        } else {
          Write-Host "NetKit.exe not found!" -ForegroundColor Red
          exit 1
        }
      shell: powershell
        
    - name: Verify build
      run: |
        # Get tag name
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $tag = "${{ github.event.inputs.tag }}"
        } else {
          $tag = "${{ github.ref_name }}"
        }
        
        if (Test-Path "dist/NetKit-$tag.exe") {
          $fileSize = (Get-Item "dist/NetKit-$tag.exe").Length
          $fileSizeMB = [math]::Round($fileSize / 1MB, 1)
          Write-Host "Build successful! File size: $fileSizeMB MB" -ForegroundColor Green
        } else {
          Write-Host "Build failed!" -ForegroundColor Red
          exit 1
        }
      shell: powershell
      
    - name: Create Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get tag name
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $tag = "${{ github.event.inputs.tag }}"
        } else {
          $tag = "${{ github.ref_name }}"
        }
        
        $buildTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $commitSha = "${{ github.sha }}"
        
        # Get file size
        $fileSize = (Get-Item "dist/NetKit-$tag.exe").Length
        $fileSizeMB = [math]::Round($fileSize / 1MB, 1)
        
        $releaseBody = "## NetKit $tag - 网络工程师工具箱`n`n### 下载`n- **NetKit-$tag.exe** - Windows 单文件版本 ($fileSizeMB MB)`n- 兼容 Windows 10/11/Server`n`n### 快速开始`n1. 下载 NetKit-$tag.exe 文件`n2. 右键选择"以管理员身份运行"`n3. 开始使用网络管理功能`n`n### 系统要求`n- Windows 10/11 或 Windows Server`n- 管理员权限（推荐用于网络配置）`n`n### 核心功能`n- IP地址快速切换`n- Ping网络测试`n- 静态路由管理`n`n### 目标用户`n专为网络工程师和系统管理员设计的实用工具`n`n---`n**构建时间**: $buildTime  `n**版本哈希**: $($commitSha.Substring(0,8))  `n**测试平台**: Windows 2019/2022/Latest"
        
        # Only create Release when pushing tags or manual trigger
        if ("${{ github.event_name }}" -eq "push" -or "${{ github.event_name }}" -eq "workflow_dispatch") {
          gh release create $tag "dist/NetKit-$tag.exe" --title "NetKit $tag" --notes $releaseBody
        } else {
          # For release events, only upload files to existing release
          gh release upload $tag "dist/NetKit-$tag.exe" --clobber
        }
        
        # Upload documentation
        if (Test-Path "docs/README.md") {
          gh release upload $tag "docs/README.md" --clobber
        }
      shell: powershell
